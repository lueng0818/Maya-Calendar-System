# app/streamlit_app.py
import streamlit as st
from datetime import datetime
from utils import load_all, kin_lookup, date_to_maya_birthday

# -----------------------------------------------------------------------------
# åˆå§‹
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="ç‘ªé›…å°è¨˜æŸ¥è©¢ç³»çµ±",
    page_icon="ğŸ—¿",
    layout="wide"
)

st.title("ğŸ—¿ ç‘ªé›…å°è¨˜æŸ¥è©¢ç³»çµ±")
st.markdown(
    """
    é€™å€‹æ‡‰ç”¨æœƒè‡ªå‹•è¼‰å…¥ `data/` è³‡æ–™å¤¾ä¸‹æ‰€æœ‰ `.csv` å’Œ `.xlsx` æª”æ¡ˆï¼Œ
    ä¸¦æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
    - **KIN æŸ¥è©¢**ï¼šè¼¸å…¥ KIN ç·¨è™Ÿï¼Œæœå°‹çŸ©é™£è¡¨ä¸­çš„å°æ‡‰è³‡æ–™ã€‚  
    - **æ—¥æœŸè½‰ç‘ªé›…ç”Ÿæ—¥**ï¼šè¼¸å…¥è¥¿å…ƒæ—¥æœŸï¼ŒæŸ¥è©¢å°æ‡‰çš„ç‘ªé›…ç”Ÿæ—¥ã€‚  
    """
)

# -----------------------------------------------------------------------------
# è¼‰å…¥æ‰€æœ‰è³‡æ–™è¡¨
# -----------------------------------------------------------------------------
with st.spinner("ğŸ“¥ æ­£åœ¨è®€å–è³‡æ–™..."):
    data_dict = load_all()
st.success(f"âœ… å·²è¼‰å…¥ {len(data_dict)} å¼µè³‡æ–™è¡¨")

# -----------------------------------------------------------------------------
# å´é‚Šé¸å–®
# -----------------------------------------------------------------------------
mode = st.sidebar.radio("é¸æ“‡åŠŸèƒ½", ["KIN æŸ¥è©¢", "æ—¥æœŸè½‰ç‘ªé›…ç”Ÿæ—¥", "æª¢è¦–å·²è¼‰å…¥è³‡æ–™è¡¨"])

# -----------------------------------------------------------------------------
# åŠŸèƒ½ï¼šæª¢è¦–å·²è¼‰å…¥è³‡æ–™è¡¨
# -----------------------------------------------------------------------------
if mode == "æª¢è¦–å·²è¼‰å…¥è³‡æ–™è¡¨":
    st.header("ğŸ“‘ å·²è¼‰å…¥è³‡æ–™è¡¨åˆ—è¡¨")
    for key in sorted(data_dict.keys()):
        df = data_dict[key]
        st.subheader(f"- `{key}` ï¼ˆ{df.shape[0]} åˆ— Ã— {df.shape[1]} æ¬„ï¼‰")
        st.dataframe(df.head(5), height=200)
    st.stop()

# -----------------------------------------------------------------------------
# åŠŸèƒ½ï¼šKIN æŸ¥è©¢
# -----------------------------------------------------------------------------
if mode == "KIN æŸ¥è©¢":
    st.header("ğŸ”¢ KIN æŸ¥è©¢")
    kin_input = st.number_input("è«‹è¼¸å…¥ KIN ç·¨è™Ÿ", min_value=1, max_value=260, value=1, step=1)
    if st.button("é–‹å§‹æŸ¥è©¢"):
        try:
            result = kin_lookup(int(kin_input), data_dict)
            st.success(f"æ‰¾åˆ° KIN {kin_input} çš„å°æ‡‰è³‡æ–™ï¼š")
            # è½‰æˆ DataFrame é¡¯ç¤º
            import pandas as pd
            df = pd.DataFrame([result])
            st.dataframe(df, use_container_width=True)
        except Exception as e:
            st.error(f"âŒ æŸ¥è©¢å¤±æ•—ï¼š{e}")

# -----------------------------------------------------------------------------
# åŠŸèƒ½ï¼šæ—¥æœŸè½‰ç‘ªé›…ç”Ÿæ—¥
# -----------------------------------------------------------------------------
elif mode == "æ—¥æœŸè½‰ç‘ªé›…ç”Ÿæ—¥":
    st.header("ğŸ“… æ—¥æœŸè½‰ç‘ªé›…ç”Ÿæ—¥")
    col1, col2 = st.columns(2)
    with col1:
        date_input = st.date_input("è«‹é¸æ“‡è¥¿å…ƒæ—¥æœŸ", datetime.today())
    with col2:
        if st.button("è½‰æ›"):
            try:
                maya_bd = date_to_maya_birthday(date_input, data_dict)
                st.success(f"å°æ‡‰çš„ç‘ªé›…ç”Ÿæ—¥ï¼š**{maya_bd}**")
            except Exception as e:
                st.error(f"âŒ è½‰æ›å¤±æ•—ï¼š{e}")
